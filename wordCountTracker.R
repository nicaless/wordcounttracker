library(ggplot2)
library(reshape2)
library(rdrop2)

token <- drop_auth()
saveRDS(token, "droptoken.rds")
# Upload droptoken to your server
# ******** WARNING ********
# Losing this file will give anyone 
# complete control of your Dropbox account
# You can then revoke the rdrop2 app from your
# dropbox account and start over.
# ******** WARNING ********
# read it back with readRDS
token <- readRDS("droptoken.rds")
# Then pass the token to each drop_ function
drop_acc(dtoken = token)

outputDir <- "wordcounttrackerdata"

saveData <- function(data) {
  #data <- t(data)
  # Create a unique file name
  fileName <- sprintf("%s_%s.csv", as.integer(Sys.time()), digest::digest(data))
  # Write the data to a temporary file locally
  filePath <- file.path(tempdir(), fileName)
  write.csv(data, filePath, row.names = FALSE, quote = TRUE)
  # Upload the file to Dropbox
  drop_upload(filePath, dest = outputDir, dtoken = token)
}

loadData <- function() {
  # Read all the files into a list
  filesInfo <- drop_dir(outputDir, dtoken = token)
  filePaths <- filesInfo$path
  data <- lapply(filePaths, drop_read_csv, stringsAsFactors = FALSE)
  # Concatenate all data together into one data.frame
  data <- do.call(rbind, data)
  return(data)
}

my_records <<- loadData()
my_records$Date = as.Date(my_records$Date)
all_records <<- my_records

recordWC <- function(wordcount, date, project, writer) {
  date = as.Date(date)
  
  if (wordcount <= 0) {
    return()
  }
  if (project == "Enter the name of your project...") {
      project = "Untitled"
  }
  if (writer == "Enter your name...") {
      writer = "anonymous"
  }
  new_record = data.frame(Date = date, Project = project, WordCount = wordcount, Writer = writer)
  all_records <<- rbind(all_records, new_record)
  paste(writer, " submitted ", 
      wordcount, " for ", 
      project, 
      " on ", date, 
      sep = "")
}


plotWC_proj <- function(minDate = Sys.Date(), maxDate = Sys.Date()) {
  rawData = all_records
  rawData$Date = as.Date(rawData$Date)
  rawData$WordCount = as.numeric(rawData$WordCount)
  if (minDate != Sys.Date() & maxDate != Sys.Date()) {
    rawData = subset(rawData, Date >= minDate)
    rawData = subset(rawData, Date <= maxDate)
    print(rawData)
  }
  if (length(unique(rawData$Writer)) > 1) {
    ggplot(data = rawData, aes(x = Date, y = WordCount, group = Writer, colour = Writer)) + geom_point()
  } else {
    ggplot(data = rawData, aes(x = Date, y = WordCount, group = Project, colour = Project)) + geom_point()
  }
}

plotWC_writer <- function(minDate = Sys.Date(), maxDate = Sys.Date()) {
  rawData = my_records
  rawData$Date = as.Date(rawData$Date)
  rawData$Word.Count = as.numeric(rawData$Word.Count)
  if (minDate != Sys.Date() & maxDate != Sys.Date()) {
    rawData = subset(rawData, Date >= minDate)
    rawData = subset(rawData, Date <= maxDate)
  }
  ggplot(data = rawData, aes(x = Date, y = Word.Count, group = Writer, colour = Writer)) + geom_line()
}
